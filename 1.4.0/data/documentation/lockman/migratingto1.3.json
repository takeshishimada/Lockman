{"abstract":[{"text":"Update your code from Lockman 1.2 to take advantage of Lockman 1.3â€™s simplified API and enhanced safety features.","type":"text"}],"kind":"article","primaryContentSections":[{"content":[{"anchor":"Overview","text":"Overview","level":2,"type":"heading"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Lockman 1.3 introduces a major API simplification by removing the "},{"code":"withLock","type":"codeVoice"},{"type":"text","text":" methods in favor of the more consistent "},{"code":"Effect.lock","type":"codeVoice"},{"type":"text","text":" method chain approach. This change eliminates API duplication and provides a cleaner, more maintainable codebase."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"The key improvements include:"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Removal of "},{"type":"codeVoice","code":"withLock"},{"type":"text","text":" methods for API consistency"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Enhanced safety through automatic lock management"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Simplified learning curve with fewer API options","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Better integration with TCAâ€™s Effect patterns"}]}]}],"type":"unorderedList"},{"anchor":"Updating-dependencies","text":"Updating dependencies","level":2,"type":"heading"},{"type":"paragraph","inlineContent":[{"type":"text","text":"To upgrade to Lockman 1.3, update your "},{"code":"Package.swift","type":"codeVoice"},{"type":"text","text":" file:"}]},{"syntax":"swift","type":"codeListing","code":["dependencies: [","  .package(","    url: \"https:\/\/github.com\/takeshishimada\/Lockman\",","    from: \"1.3.0\"","  )","]"]},{"anchor":"Breaking-changes","text":"Breaking changes","level":2,"type":"heading"},{"anchor":"Removal-of-withLock-methods","text":"Removal of withLock methods","level":3,"type":"heading"},{"type":"paragraph","inlineContent":[{"type":"text","text":"All "},{"type":"codeVoice","code":"withLock"},{"type":"text","text":" methods have been removed. Use "},{"type":"codeVoice","code":"Effect.lock"},{"type":"text","text":" method chain or "},{"type":"codeVoice","code":"Reducer.lock"},{"type":"text","text":" instead."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"ðŸš« Before (1.2):"}]},{"syntax":"swift","type":"codeListing","code":["return .withLock(","  operation: { send in","    try await performWork()","    await send(.completed)","  },","  catch handler: { error, send in","    await send(.failed(error))","  },","  lockFailure: { error, send in","    await send(.lockFailed)","  },","  action: action,","  boundaryId: CancelID.operation",")"]},{"type":"paragraph","inlineContent":[{"text":"âœ… After (1.3):","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["return .run { send in","  try await performWork()","  await send(.completed)","} catch: { error, send in","  await send(.failed(error))","}",".lock(","  action: action,","  boundaryId: CancelID.operation,","  lockFailure: { error, send in","    await send(.lockFailed)","  }",")"]},{"anchor":"Removal-of-withLockconcatenating","text":"Removal of withLock(concatenating:)","level":3,"type":"heading"},{"type":"paragraph","inlineContent":[{"text":"The ","type":"text"},{"type":"codeVoice","code":"withLock(concatenating:)"},{"text":" method has been renamed to ","type":"text"},{"type":"codeVoice","code":"Effect.lock(concatenating:)"},{"text":".","type":"text"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"ðŸš« Before (1.2):"}]},{"syntax":"swift","type":"codeListing","code":["return .withLock(","  concatenating: [","    .run { send in await step1() },","    .run { send in await step2() },","    .run { send in await step3() }","  ],","  action: action,","  boundaryId: CancelID.workflow",")"]},{"type":"paragraph","inlineContent":[{"text":"âœ… After (1.3):","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["return .lock(","  concatenating: [","    .run { send in await step1() },","    .run { send in await step2() },","    .run { send in await step3() }","  ],","  action: action,","  boundaryId: CancelID.workflow",")"]},{"anchor":"Manual-unlock-functionality-removed","text":"Manual unlock functionality removed","level":3,"type":"heading"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Manual unlock functionality (unlock parameter in operation) has been removed. All locks are now automatically managed."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"ðŸš« Before (1.2):"}]},{"syntax":"swift","type":"codeListing","code":["return .withLock(","  operation: { send, unlock in","    defer { unlock() }","    try await performWork()","    await send(.completed)","  },","  action: action,","  boundaryId: CancelID.operation",")"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"âœ… After (1.3):"}]},{"syntax":"swift","type":"codeListing","code":["return .run { send in","  try await performWork()","  await send(.completed)","}",".lock(","  action: action,","  boundaryId: CancelID.operation,","  unlockOption: .immediate \/\/ Control timing instead",")"]},{"anchor":"Migration-strategy","text":"Migration strategy","level":2,"type":"heading"},{"anchor":"Step-1-Replace-withLock-with-Effectlock","text":"Step 1: Replace withLock with Effect.lock","level":3,"type":"heading"},{"type":"paragraph","inlineContent":[{"text":"For each ","type":"text"},{"code":"withLock","type":"codeVoice"},{"text":" call:","type":"text"}]},{"items":[{"content":[{"inlineContent":[{"text":"Move the operation closure to a ","type":"text"},{"type":"codeVoice","code":".run { }"},{"text":" effect","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Move the catch handler to ","type":"text"},{"code":".catch { }","type":"codeVoice"},{"text":" if present","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Chain ","type":"text"},{"code":".lock()","type":"codeVoice"},{"text":" with the action and boundary parameters","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Move lockFailure to the lock method"}],"type":"paragraph"}]}],"type":"orderedList"},{"anchor":"Step-2-Replace-withLockconcatenating-calls","text":"Step 2: Replace withLock(concatenating:) calls","level":3,"type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Change method name from "},{"type":"codeVoice","code":".withLock(concatenating:"},{"type":"text","text":" to "},{"type":"codeVoice","code":".lock(concatenating:"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Parameters remain the same","type":"text"}]}]}],"type":"orderedList"},{"anchor":"Step-3-Remove-manual-unlock-usage","text":"Step 3: Remove manual unlock usage","level":3,"type":"heading"},{"items":[{"content":[{"inlineContent":[{"text":"Remove ","type":"text"},{"code":"unlock","type":"codeVoice"},{"text":" parameter from operation closures","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Remove manual "},{"type":"codeVoice","code":"unlock()"},{"type":"text","text":" calls"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Use ","type":"text"},{"type":"codeVoice","code":"unlockOption"},{"text":" parameter to control timing if needed","type":"text"}],"type":"paragraph"}]}],"type":"orderedList"},{"anchor":"Complete-migration-examples","text":"Complete migration examples","level":2,"type":"heading"},{"anchor":"Basic-operation-migration","text":"Basic operation migration","level":3,"type":"heading"},{"type":"paragraph","inlineContent":[{"text":"ðŸš« Before (1.2):","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["case .fetchData:","  return .withLock(","    operation: { send in","      let data = try await apiClient.fetchData()","      await send(.dataReceived(data))","    },","    catch handler: { error, send in","      await send(.fetchFailed(error))","    },","    lockFailure: { error, send in","      await send(.fetchBlocked)","    },","    action: action,","    boundaryId: CancelID.fetch","  )"]},{"type":"paragraph","inlineContent":[{"text":"âœ… After (1.3):","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["case .fetchData:","  return .run { send in","    let data = try await apiClient.fetchData()","    await send(.dataReceived(data))","  } catch: { error, send in","    await send(.fetchFailed(error))","  }","  .lock(","    action: action,","    boundaryId: CancelID.fetch,","    lockFailure: { error, send in","      await send(.fetchBlocked)","    }","  )"]},{"anchor":"Concatenated-operations-migration","text":"Concatenated operations migration","level":3,"type":"heading"},{"type":"paragraph","inlineContent":[{"text":"ðŸš« Before (1.2):","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["case .processWorkflow:","  return .withLock(","    concatenating: [","      .send(.workflowStarted),","      .run { send in await processStep1() },","      .run { send in await processStep2() },","      .send(.workflowCompleted)","    ],","    unlockOption: .transition,","    action: action,","    boundaryId: CancelID.workflow","  )"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"âœ… After (1.3):"}]},{"syntax":"swift","type":"codeListing","code":["case .processWorkflow:","  return .lock(","    concatenating: [","      .send(.workflowStarted),","      .run { send in await processStep1() },","      .run { send in await processStep2() },","      .send(.workflowCompleted)","    ],","    unlockOption: .transition,","    action: action,","    boundaryId: CancelID.workflow","  )"]},{"anchor":"Complex-manual-unlock-migration","text":"Complex manual unlock migration","level":3,"type":"heading"},{"type":"paragraph","inlineContent":[{"text":"ðŸš« Before (1.2):","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["case .complexOperation:","  return .withLock(","    operation: { send, unlock in","      try await phase1()","      ","      if shouldSkipPhase2 {","        unlock()","        await send(.skipped)","        return","      }","      ","      try await phase2()","      unlock()","      await send(.completed)","    },","    catch handler: { error, send, unlock in","      unlock()","      await send(.failed(error))","    },","    action: action,","    boundaryId: CancelID.complex","  )"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"âœ… After (1.3):"}]},{"syntax":"swift","type":"codeListing","code":["case .complexOperation:","  return .run { send in","    try await phase1()","    ","    if shouldSkipPhase2 {","      await send(.skipped)","      return","    }","    ","    try await phase2()","    await send(.completed)","  } catch: { error, send in","    await send(.failed(error))","  }","  .lock(","    action: action,","    boundaryId: CancelID.complex,","    unlockOption: .immediate \/\/ Automatic timing control","  )"]},{"anchor":"Benefits-of-upgrading","text":"Benefits of upgrading","level":2,"type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"inlineContent":[{"type":"text","text":"Simplified API"}],"type":"strong"},{"text":": Single consistent method chain approach","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"strong","inlineContent":[{"text":"Enhanced safety","type":"text"}]},{"text":": Automatic lock management prevents lock leaks","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Better TCA integration"}]},{"type":"text","text":": Natural fit with Effect patterns"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"text":"Reduced learning curve","type":"text"}]},{"type":"text","text":": Fewer API variants to learn"}]}]},{"content":[{"inlineContent":[{"type":"strong","inlineContent":[{"text":"Improved maintainability","type":"text"}]},{"type":"text","text":": Cleaner, more predictable code patterns"}],"type":"paragraph"}]}],"type":"orderedList"},{"anchor":"API-mapping-reference","text":"API mapping reference","level":2,"type":"heading"},{"header":"row","rows":[[[{"inlineContent":[{"type":"text","text":"Old API (1.2)"}],"type":"paragraph"}],[{"inlineContent":[{"type":"text","text":"New API (1.3)"}],"type":"paragraph"}]],[[{"inlineContent":[{"type":"codeVoice","code":".withLock(operation:...)"}],"type":"paragraph"}],[{"inlineContent":[{"type":"codeVoice","code":".run {...}.lock(...)"}],"type":"paragraph"}]],[[{"inlineContent":[{"code":".withLock(concatenating:...)","type":"codeVoice"}],"type":"paragraph"}],[{"inlineContent":[{"type":"codeVoice","code":".lock(concatenating:...)"}],"type":"paragraph"}]],[[{"inlineContent":[{"type":"codeVoice","code":"operation: { send, unlock in }"}],"type":"paragraph"}],[{"inlineContent":[{"type":"codeVoice","code":".run { send in }"},{"text":" with ","type":"text"},{"type":"codeVoice","code":"unlockOption"}],"type":"paragraph"}]],[[{"inlineContent":[{"type":"text","text":"Manual "},{"code":"unlock()","type":"codeVoice"},{"type":"text","text":" calls"}],"type":"paragraph"}],[{"inlineContent":[{"type":"text","text":"Automatic with "},{"type":"codeVoice","code":"unlockOption"},{"type":"text","text":" control"}],"type":"paragraph"}]]],"type":"table"},{"anchor":"Testing-your-migration","text":"Testing your migration","level":2,"type":"heading"},{"type":"paragraph","inlineContent":[{"text":"After migrating, verify that:","type":"text"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Lock behavior is maintained"}]},{"type":"text","text":": Operations are still properly locked"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"text":"Error handling works","type":"text"}]},{"type":"text","text":": Both operation errors and lock failures are handled"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"inlineContent":[{"text":"Timing is correct","type":"text"}],"type":"strong"},{"text":": Use ","type":"text"},{"type":"codeVoice","code":"unlockOption"},{"text":" to adjust timing if needed","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Performance is maintained"}]},{"type":"text","text":": No regression in lock performance"}]}]}],"type":"orderedList"},{"anchor":"Summary","text":"Summary","level":2,"type":"heading"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Lockman 1.3 represents a significant API simplification while maintaining all the functionality and safety guarantees of previous versions. The migration primarily involves moving from "},{"type":"codeVoice","code":"withLock"},{"type":"text","text":" to "},{"type":"codeVoice","code":"Effect.lock"},{"type":"text","text":" method chains, which provides a cleaner and more consistent API surface."}]},{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Key takeaways:"}]}]},{"items":[{"content":[{"inlineContent":[{"inlineContent":[{"type":"text","text":"Breaking changes"}],"type":"strong"},{"text":": ","type":"text"},{"code":"withLock","type":"codeVoice"},{"text":" methods removed","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"strong","inlineContent":[{"text":"Consistent API","type":"text"}]},{"type":"text","text":": Single method chain approach with "},{"type":"codeVoice","code":"Effect.lock"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"strong","inlineContent":[{"text":"Enhanced safety","type":"text"}]},{"type":"text","text":": Automatic lock management only"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"inlineContent":[{"text":"Better integration","type":"text"}],"type":"strong"},{"text":": Natural fit with TCA Effect patterns","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"type":"text","text":"The new API eliminates confusion between different locking approaches and provides a more maintainable codebase going forward."}]}],"kind":"content"}],"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/Lockman\/documentation\/Lockman\/MigratingTo1.3"},"variants":[{"paths":["\/documentation\/lockman\/migratingto1.3"],"traits":[{"interfaceLanguage":"swift"}]}],"schemaVersion":{"minor":3,"patch":0,"major":0},"metadata":{"modules":[{"name":"Lockman"}],"roleHeading":"Article","role":"article","title":"Migrating to 1.3"},"hierarchy":{"paths":[["doc:\/\/Lockman\/documentation\/Lockman"]]},"sections":[],"references":{"doc://Lockman/documentation/Lockman":{"url":"\/documentation\/lockman","title":"Lockman","kind":"symbol","identifier":"doc:\/\/Lockman\/documentation\/Lockman","abstract":[{"text":"A library to implement exclusive control of user actions in application development using TCA.","type":"text"}],"type":"topic","role":"collection"}}}