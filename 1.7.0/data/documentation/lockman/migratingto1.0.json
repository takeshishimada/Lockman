{"abstract":[{"type":"text","text":"Update your code from Lockman 0.13.4 to take advantage of Lockman 1.0â€™s improved APIs and enhanced error handling."}],"primaryContentSections":[{"content":[{"type":"heading","level":2,"anchor":"Overview","text":"Overview"},{"type":"paragraph","inlineContent":[{"text":"Lockman 1.0 brings significant improvements to API consistency, error handling, and overall developer experience. This guide will help you migrate your existing Lockman 0.13.4+ code to the new 1.0 APIs.","type":"text"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"The most significant changes include:"}]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"Renamed APIs for better Swift naming conventions"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Enhanced error handling with the new "},{"type":"codeVoice","code":"LockmanCancellationError"},{"type":"text","text":" protocol"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Unified parameter naming across all APIs"}]}]},{"content":[{"inlineContent":[{"text":"Improved reducer integration with the new ","type":"text"},{"type":"codeVoice","code":"Reducer.lock"},{"text":" method","type":"text"}],"type":"paragraph"}]}]},{"type":"heading","level":2,"anchor":"Updating-dependencies","text":"Updating dependencies"},{"type":"paragraph","inlineContent":[{"text":"To upgrade to Lockman 1.0, update your ","type":"text"},{"code":"Package.swift","type":"codeVoice"},{"text":" file:","type":"text"}]},{"type":"codeListing","syntax":"swift","code":["dependencies: [","  .package(","    url: \"https:\/\/github.com\/takeshishimada\/Lockman\",","    from: \"1.0.0\"","  )","]"]},{"type":"heading","level":2,"anchor":"API-renames-and-replacements","text":"API renames and replacements"},{"type":"heading","level":3,"anchor":"concatenateWithLock-%E2%86%92-withLockconcatenating","text":"`concatenateWithLock` â†’ `withLock(concatenating:)`"},{"type":"paragraph","inlineContent":[{"type":"text","text":"The "},{"type":"codeVoice","code":"concatenateWithLock"},{"type":"text","text":" method has been renamed to "},{"type":"codeVoice","code":"withLock(concatenating:)"},{"type":"text","text":" to follow Swiftâ€™s parameter labeling conventions and create a more consistent API surface."}]},{"type":"paragraph","inlineContent":[{"text":"ðŸš« Before:","type":"text"}]},{"code":["return .concatenateWithLock(","  unlockOption: .immediate,","  operations: [","    .run { send in await fetchData() },","    .run { send in await processData() },","    .run { send in await saveData() }","  ],","  action: action,","  boundaryId: CancelID.operation",")"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"text":"âœ… After:","type":"text"}],"type":"paragraph"},{"code":["return .withLock(","  concatenating: [","    .run { send in await fetchData() },","    .run { send in await processData() },","    .run { send in await saveData() }","  ],","  unlockOption: .immediate,","  action: action,","  boundaryId: CancelID.operation",")"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"text":"Note that the parameter order has changed: ","type":"text"},{"code":"concatenating","type":"codeVoice"},{"text":" is now the first parameter with a label, making the API more readable.","type":"text"}],"type":"paragraph"},{"text":"`Reducer.withLock` â†’ `Reducer.lock`","anchor":"ReducerwithLock-%E2%86%92-Reducerlock","type":"heading","level":3},{"inlineContent":[{"type":"text","text":"The reducer modifier has been simplified from "},{"type":"codeVoice","code":"withLock"},{"type":"text","text":" to "},{"type":"codeVoice","code":"lock"},{"type":"text","text":" for better clarity and consistency."}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"ðŸš« Before:"}],"type":"paragraph"},{"code":["var body: some ReducerOf<Self> {","  Reduce { state, action in","    \/\/ reducer logic","  }","  .withLock(","    boundaryId: CancelID.feature,","    for: \\.view","  )","}"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"type":"text","text":"âœ… After:"}],"type":"paragraph"},{"code":["var body: some ReducerOf<Self> {","  Reduce { state, action in","    \/\/ reducer logic","  }","  .lock(","    boundaryId: CancelID.feature,","    for: \\.view","  )","}"],"type":"codeListing","syntax":"swift"},{"text":"Parameter rename: `id` â†’ `boundaryId`","anchor":"Parameter-rename-id-%E2%86%92-boundaryId","type":"heading","level":3},{"inlineContent":[{"type":"text","text":"All APIs that previously used the parameter name "},{"code":"id","type":"codeVoice"},{"type":"text","text":" now use "},{"code":"boundaryId","type":"codeVoice"},{"type":"text","text":" for clarity."}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"ðŸš« Before:"}],"type":"paragraph"},{"code":[".withLock(","  operation: { send in \/* ... *\/ },","  action: action,","  id: CancelID.operation",")"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"type":"text","text":"âœ… After:"}],"type":"paragraph"},{"code":[".withLock(","  operation: { send in \/* ... *\/ },","  action: action,","  boundaryId: CancelID.operation",")"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"text":"This change affects all lock-related APIs including ","type":"text"},{"code":"withLock","type":"codeVoice"},{"text":", ","type":"text"},{"code":"Effect.lock","type":"codeVoice"},{"text":", and ","type":"text"},{"code":"Reducer.lock","type":"codeVoice"},{"text":".","type":"text"}],"type":"paragraph"},{"text":"Error handling improvements","anchor":"Error-handling-improvements","type":"heading","level":2},{"text":"New `LockmanCancellationError` wrapper","anchor":"New-LockmanCancellationError-wrapper","type":"heading","level":3},{"inlineContent":[{"type":"text","text":"Lockman 1.0 introduces a new error handling model where all lock acquisition failures are wrapped in "},{"type":"codeVoice","code":"LockmanCancellationError"},{"type":"text","text":". This provides better context about which action failed and why."}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"ðŸš« Before:"}],"type":"paragraph"},{"code":[".lock(","  boundaryId: CancelID.operation,","  lockFailure: { error, send in","    if let singleExecutionError = error as? LockmanSingleExecutionError {","      \/\/ Handle single execution error","    } else if let priorityError = error as? LockmanPriorityBasedError {","      \/\/ Handle priority-based error","    }","  }",")"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"type":"text","text":"âœ… After:"}],"type":"paragraph"},{"code":[".lock(","  boundaryId: CancelID.operation,","  lockFailure: { error, send in","    guard let cancellationError = error as? LockmanCancellationError else { return }","    ","    \/\/ Access the action that caused the error","    let failedAction = cancellationError.action","    ","    \/\/ Access the underlying strategy error","    switch cancellationError.reason {","    case let singleExecutionError as LockmanSingleExecutionError:","      \/\/ Handle single execution error","    case let priorityError as LockmanPriorityBasedError:","      \/\/ Handle priority-based error","    default:","      break","    }","  }",")"],"type":"codeListing","syntax":"swift"},{"text":"Error type renames","anchor":"Error-type-renames","type":"heading","level":3},{"inlineContent":[{"type":"text","text":"Several error types have been renamed for consistency:"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"codeVoice","code":"LockmanSingleExecutionError"},{"type":"text","text":" â†’ "},{"type":"codeVoice","code":"LockmanSingleExecutionCancellationError"},{"type":"text","text":" (for cancellation cases)"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"codeVoice","code":"LockmanPriorityBasedError"},{"type":"text","text":" has specific cases:"}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"codeVoice","code":".precedingActionCancelled"},{"text":" â†’ ","type":"text"},{"type":"codeVoice","code":"LockmanPriorityBasedCancellationError"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"code":".higherPriorityExists","type":"codeVoice"},{"type":"text","text":" â†’ "},{"code":"LockmanPriorityBasedBlockedError","type":"codeVoice"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"codeVoice","code":".samePriorityConflict"},{"text":" â†’ ","type":"text"},{"type":"codeVoice","code":"LockmanPriorityBasedBlockedError"}]}]}]}]}],"type":"unorderedList"},{"text":"`LockmanResult` enum changes","anchor":"LockmanResult-enum-changes","type":"heading","level":3},{"inlineContent":[{"type":"text","text":"The "},{"type":"codeVoice","code":"LockmanResult"},{"type":"text","text":" enum case has been renamed for clarity:"}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"ðŸš« Before:"}],"type":"paragraph"},{"code":["switch result {","case .success:","  \/\/ Handle success","case .successWithPrecedingCancellation:","  \/\/ Handle cancellation","case .failure:","  \/\/ Handle failure","}"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"text":"âœ… After:","type":"text"}],"type":"paragraph"},{"code":["switch result {","case .success:","  \/\/ Handle success","case .successWithPrecedingCancellation:","  \/\/ Handle cancellation","case .cancel:  \/\/ Renamed from .failure","  \/\/ Handle cancellation","}"],"type":"codeListing","syntax":"swift"},{"text":"Complete migration example","anchor":"Complete-migration-example","type":"heading","level":2},{"inlineContent":[{"type":"text","text":"Hereâ€™s a complete example showing how to migrate a typical Lockman integration:"}],"type":"paragraph"},{"inlineContent":[{"text":"ðŸš« Before (0.13.4):","type":"text"}],"type":"paragraph"},{"code":["@Reducer","struct Feature {","  @ObservableState","  struct State: Equatable {","    var data: [Item] = []","    var isLoading = false","  }","  ","  enum Action: ViewAction {","    case view(View)","    ","    @CasePathable","    enum View: LockmanAction {","      case refreshTapped","      case loadMore","      ","      var lockmanInfo: LockmanSingleExecutionInfo {","        LockmanSingleExecutionInfo(","          actionId: \"\\(self)\",","          mode: .action","        )","      }","    }","  }","  ","  var body: some ReducerOf<Self> {","    Reduce { state, action in","      switch action {","      case .view(.refreshTapped):","        return .concatenateWithLock(","          unlockOption: .immediate,","          operations: [","            .send(.setLoading(true)),","            .run { send in ","              let data = try await api.fetchData()","              await send(.dataLoaded(data))","            },","            .send(.setLoading(false))","          ],","          action: action,","          id: CancelID.refresh","        )","      }","    }","    .withLock(","      id: CancelID.feature,","      lockFailure: { error, send in","        if error is LockmanSingleExecutionError {","          await send(.showError(\"Already refreshing\"))","        }","      },","      for: \\.view","    )","  }","}"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"type":"text","text":"âœ… After (1.0):"}],"type":"paragraph"},{"code":["@Reducer","struct Feature {","  @ObservableState","  struct State: Equatable {","    var data: [Item] = []","    var isLoading = false","  }","  ","  enum Action: ViewAction {","    case view(View)","    ","    @CasePathable","    enum View: LockmanAction {","      case refreshTapped","      case loadMore","      ","      var lockmanInfo: LockmanSingleExecutionInfo {","        LockmanSingleExecutionInfo(","          actionId: \"\\(self)\",","          mode: .action","        )","      }","    }","  }","  ","  var body: some ReducerOf<Self> {","    Reduce { state, action in","      switch action {","      case .view(.refreshTapped):","        return .withLock(","          concatenating: [","            .send(.setLoading(true)),","            .run { send in ","              let data = try await api.fetchData()","              await send(.dataLoaded(data))","            },","            .send(.setLoading(false))","          ],","          unlockOption: .immediate,","          action: action,","          boundaryId: CancelID.refresh  \/\/ Renamed from 'id'","        )","      }","    }","    .lock(  \/\/ Renamed from 'withLock'","      boundaryId: CancelID.feature,  \/\/ Renamed from 'id'","      lockFailure: { error, send in","        guard let cancellationError = error as? LockmanCancellationError,","              cancellationError.reason is LockmanSingleExecutionCancellationError else {","          return","        }","        await send(.showError(\"Already refreshing\"))","      },","      for: \\.view","    )","  }","}"],"type":"codeListing","syntax":"swift"},{"text":"Quick reference","anchor":"Quick-reference","type":"heading","level":2},{"header":"row","rows":[[[{"inlineContent":[{"text":"Old API","type":"text"}],"type":"paragraph"}],[{"inlineContent":[{"type":"text","text":"New API"}],"type":"paragraph"}]],[[{"inlineContent":[{"code":"concatenateWithLock(operations:...)","type":"codeVoice"}],"type":"paragraph"}],[{"inlineContent":[{"type":"codeVoice","code":"withLock(concatenating:...)"}],"type":"paragraph"}]],[[{"inlineContent":[{"code":"Reducer.withLock","type":"codeVoice"}],"type":"paragraph"}],[{"inlineContent":[{"type":"codeVoice","code":"Reducer.lock"}],"type":"paragraph"}]],[[{"inlineContent":[{"type":"codeVoice","code":"id:"},{"type":"text","text":" parameter"}],"type":"paragraph"}],[{"inlineContent":[{"type":"codeVoice","code":"boundaryId:"},{"type":"text","text":" parameter"}],"type":"paragraph"}]],[[{"inlineContent":[{"type":"text","text":"Direct strategy errors"}],"type":"paragraph"}],[{"inlineContent":[{"type":"text","text":"Wrapped in "},{"type":"codeVoice","code":"LockmanCancellationError"}],"type":"paragraph"}]],[[{"inlineContent":[{"code":"LockmanResult.failure","type":"codeVoice"}],"type":"paragraph"}],[{"inlineContent":[{"type":"codeVoice","code":"LockmanResult.cancel"}],"type":"paragraph"}]]],"type":"table"},{"text":"Tips for migration","anchor":"Tips-for-migration","type":"heading","level":2},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"inlineContent":[{"type":"text","text":"Use Xcodeâ€™s Find and Replace"}],"type":"strong"},{"type":"text","text":": Many of these changes can be automated using Xcodeâ€™s find and replace feature with regular expressions."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"text":"Update error handling first","type":"text"}]},{"type":"text","text":": Start by updating your error handling code to work with "},{"type":"codeVoice","code":"LockmanCancellationError"},{"type":"text","text":", as this will help you identify all the places where lock failures are handled."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Test incrementally"}]},{"type":"text","text":": After making each set of changes, run your tests to ensure everything still works as expected."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"inlineContent":[{"text":"Review lock failure handlers","type":"text"}],"type":"strong"},{"type":"text","text":": The new error wrapping provides more context, so consider whether you can improve your error handling logic."}]}]}],"type":"orderedList"},{"text":"Need help?","anchor":"Need-help","type":"heading","level":2},{"inlineContent":[{"text":"If you encounter any issues during migration, please:","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Check the "},{"overridingTitle":"API documentation","overridingTitleInlineContent":[{"type":"text","text":"API documentation"}],"identifier":"doc:\/\/Lockman\/documentation\/Lockman","type":"reference","isActive":true},{"type":"text","text":" for detailed information about each API"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Review the ","type":"text"},{"isActive":true,"identifier":"https:\/\/github.com\/takeshishimada\/Lockman\/tree\/main\/Examples","type":"reference"},{"text":" for working code samples","type":"text"}]}]},{"content":[{"inlineContent":[{"isActive":true,"identifier":"https:\/\/github.com\/takeshishimada\/Lockman\/issues","type":"reference"},{"text":" if you find any problems","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"},{"text":"Conclusion","anchor":"Conclusion","type":"heading","level":2},{"inlineContent":[{"text":"Lockman 1.0â€™s changes improve API consistency and provide better error handling capabilities. While the migration requires some code changes, the improvements in developer experience and code clarity make it worthwhile. The new APIs follow Swift conventions more closely and provide better integration with The Composable Architecture.","type":"text"}],"type":"paragraph"}],"kind":"content"}],"kind":"article","schemaVersion":{"major":0,"minor":3,"patch":0},"hierarchy":{"paths":[["doc:\/\/Lockman\/documentation\/Lockman"]]},"sections":[],"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/lockman\/migratingto1.0"]}],"identifier":{"url":"doc:\/\/Lockman\/documentation\/Lockman\/MigratingTo1.0","interfaceLanguage":"swift"},"metadata":{"role":"article","modules":[{"name":"Lockman"}],"roleHeading":"Article","title":"Migrating to 1.0"},"references":{"https://github.com/takeshishimada/Lockman/tree/main/Examples":{"identifier":"https:\/\/github.com\/takeshishimada\/Lockman\/tree\/main\/Examples","type":"link","title":"example projects","titleInlineContent":[{"text":"example projects","type":"text"}],"url":"https:\/\/github.com\/takeshishimada\/Lockman\/tree\/main\/Examples"},"doc://Lockman/documentation/Lockman":{"abstract":[{"type":"text","text":"Elegant exclusive control for user actions in The Composable Architecture applications."}],"url":"\/documentation\/lockman","identifier":"doc:\/\/Lockman\/documentation\/Lockman","title":"Lockman","kind":"symbol","type":"topic","role":"collection"},"https://github.com/takeshishimada/Lockman/issues":{"type":"link","title":"Open an issue","titleInlineContent":[{"type":"text","text":"Open an issue"}],"url":"https:\/\/github.com\/takeshishimada\/Lockman\/issues","identifier":"https:\/\/github.com\/takeshishimada\/Lockman\/issues"}}}